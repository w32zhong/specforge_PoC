FROM nvcr.io/nvidia/cuda:12.9.1-cudnn-devel-ubuntu20.04
ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /workspace
# install utilities
RUN apt update && apt install -y git tmux ncdu vim npm python3-pip
# ensure UTF-8 locale is generated
RUN apt-get install -y locales && \
    sed -i 's/^# *en_US.UTF-8/en_US.UTF-8/' /etc/locale.gen && \
    locale-gen
# setup dotfiles
RUN bash -c "git clone https://github.com/t-k-cloud/tkarch.git && \
    pushd tkarch && cd dotfiles && ./overwrite.sh && \
    popd && rm -rf tkarch/.git"
# install nvitop
RUN pip install nvitop
# install nvim
RUN apt install -y curl
RUN curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.tar.gz && \
    tar -xzf nvim-linux-x86_64.tar.gz && ln -sf `pwd`/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim
# install node and LSP
RUN apt install -y wget
RUN wget https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh && \
    bash install.sh && bash -c 'source ~/.nvm/nvm.sh && nvm install v24.5.0'
RUN npm install -g pyright
# sglang
RUN pip install fire packaging
RUN git clone --depth=1 -b v0.5.2 https://github.com/sgl-project/sglang.git
RUN apt update && apt install wget -y && apt install software-properties-common -y \
    && add-apt-repository ppa:deadsnakes/ppa -y \
    && apt install python3.12-full python3.12-dev python3.10-venv -y \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1 \
    && update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 2 \
    && update-alternatives --set python3 /usr/bin/python3.12 \
    && wget https://bootstrap.pypa.io/get-pip.py \
    && python3 get-pip.py # everything here are for python3.12
RUN cd sglang/python && pip install -e .
RUN cd sglang/python && pip install -e ".[srt]" # SGLang Run Time
RUN apt install -y libnuma1 libnuma-dev # some missing system libs
RUN python3 -m pip install --no-cache-dir --upgrade pip setuptools
# specforge_PoC
RUN wget https://raw.githubusercontent.com/w32zhong/specforge_PoC/refs/heads/master/specforge_het/requirements.txt -O r1.txt
RUN bash -c "pip install -r <(grep -v -i '^transformers\b' r1.txt)" # transformers version is up to SGLang
# final touch-ups
RUN ln -sf /usr/bin/python3 /usr/bin/python
